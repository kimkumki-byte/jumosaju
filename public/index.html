<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì£¼ëª¨ì—¬ê¸°ì‚¬ì£¼ìš” ğŸ¶</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --yellow-custom:#F6D66D;
      --green-custom:#1F6F59;
      --black:#111;
    }
    .bg-yellow_custom{ background: var(--yellow-custom); }
    .bg-green_custom{ background: var(--green-custom); }
    .border-black{ border-color: var(--black); }
    .shadow-card{ box-shadow: 0 10px 30px rgba(0,0,0,.12); }
    .btn-main{
      @apply w-full rounded-xl bg-black text-white py-3 font-bold active:scale-[0.98] transition;
    }
  </style>
</head>
<body class="bg-zinc-100 min-h-screen">
  <div class="max-w-sm mx-auto bg-white min-h-screen shadow-card">
    <!-- Header -->
    <div class="p-4 border-b border-black text-center bg-yellow_custom">
      <h1 class="text-lg font-bold mb-1">ì£¼ëª¨ì—¬ê¸°ì‚¬ì£¼ìš” ğŸ¶</h1>
      <p class="text-xs text-gray-700">ë§Œì„¸ë ¥ì€ ì •í™•í•˜ê²Œ, í•´ì„¤ì€ êµ¬ìˆ˜í•˜ê²Œ</p>
    </div>

    <!-- Form -->
    <div id="formSection" class="p-4 space-y-4">
      <div class="space-y-2">
        <label class="text-sm font-semibold">ì´ë¦„</label>
        <input id="nameInput" class="w-full border border-black rounded-lg px-3 py-2" placeholder="ì´ë¦„ì„ ì ì–´ë³´ìŠˆ" />
      </div>

      <div class="space-y-2">
        <label class="text-sm font-semibold">ìƒë…„ì›”ì¼</label>
        <input id="dateInput" type="date" class="w-full border border-black rounded-lg px-3 py-2" />
        <div class="flex gap-2">
          <button id="solarBtn" class="flex-1 border border-black rounded-lg py-2 text-sm font-semibold bg-black text-white">ì–‘ë ¥</button>
          <button id="lunarBtn" class="flex-1 border border-black rounded-lg py-2 text-sm font-semibold bg-white">ìŒë ¥</button>
          <button id="leapBtn" class="flex-1 border border-black rounded-lg py-2 text-sm font-semibold bg-white">ìœ¤ë‹¬</button>
        </div>
        <p class="text-[11px] text-gray-500">ìœ¤ë‹¬ì€ ìŒë ¥ì¼ ë•Œë§Œ ì˜ë¯¸ ìˆìˆ˜ë‹¤.</p>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-semibold">ì‹œê°„</label>
        <select id="timeMode" class="w-full border border-black rounded-lg px-3 py-2">
          <option value="unknown">ì‹œê°„ ëª¨ë¦„</option>
          <option value="known">ì‹œê°„ ì„ íƒ</option>
        </select>
        <input id="timeInput" type="time" class="w-full border border-black rounded-lg px-3 py-2 hidden" value="12:00" />
      </div>

      <div class="space-y-2">
        <label class="text-sm font-semibold">ì„±ë³„</label>
        <div class="flex gap-2">
          <button id="maleBtn" class="flex-1 border border-black rounded-lg py-2 text-sm font-semibold bg-black text-white">ë„ë ¹</button>
          <button id="femaleBtn" class="flex-1 border border-black rounded-lg py-2 text-sm font-semibold bg-white">ì•„ê°€ì”¨</button>
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-semibold">ìŒ/ì–‘</label>
        <div class="flex gap-2">
          <button id="yinBtn" class="flex-1 border border-black rounded-lg py-2 text-sm font-semibold bg-white">ìŒ</button>
          <button id="yangBtn" class="flex-1 border border-black rounded-lg py-2 text-sm font-semibold bg-black text-white">ì–‘</button>
        </div>
        <p class="text-[11px] text-gray-500">ì—¬ê¸°ì„œëŠ” 'í’€ì´ ìŠ¤íƒ€ì¼(ë§ì˜ ê²°)'ì—ë§Œ ì“°ê³ , ë§Œì„¸ë ¥ ê³„ì‚°ê°’ì€ ìƒë…„ì›”ì¼/ì‹œê°„ìœ¼ë¡œ ê²°ì •ë¼ìš”.</p>
      </div>

      <button id="submitBtn" class="w-full rounded-xl bg-black text-white py-3 font-bold active:scale-[0.98] transition">ğŸ¶ ì£¼ëª¨! ì‚¬ì£¼ ì¢€ ë´ì¤˜!</button>
      <button id="resetBtn" class="w-full rounded-xl border border-black py-3 font-bold hidden">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë³´ê¸°</button>

      <div class="text-center text-xs text-gray-500 pt-2">
        ì¬ë¯¸ë¡œë§Œ ë³´ìŠˆ~ (ì˜í•™/ë²•ë¥ /íˆ¬ì ê²°ì •ì€ ì „ë¬¸ê°€ì™€ ìƒì˜!)
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="p-6 hidden">
      <div class="rounded-2xl border border-black p-5 bg-yellow_custom">
        <div class="font-bold mb-2">ì£¼ëª¨ê°€ í–¥ë¶ˆ í”¼ìš°ëŠ” ì¤‘ì´ìˆ˜ë‹¤â€¦</div>
        <div id="loadingText" class="text-sm text-gray-800"></div>
      </div>
    </div>

    <!-- Result -->
    <div id="result" class="hidden">
      <!-- top summary -->
      <div class="p-4 border-b border-black text-center bg-yellow_custom">
        <h1 id="titleName" class="text-lg font-bold mb-2"></h1>
        <div class="mt-2 flex flex-col items-center gap-2 text-xs">
          <div id="tagRow1" class="flex flex-wrap justify-center gap-2"></div>
          <div id="tagRow2" class="flex flex-wrap justify-center gap-2"></div>
        </div>
      </div>

      <!-- ë§Œì„¸ë ¥ -->
      <div class="p-2 bg-green_custom">
        <h2 class="text-lg font-bold text-white text-center">ë§Œì„¸ë ¥</h2>
      </div>

      <div id="manseWrap"></div>

      <!-- ì‚¬ì£¼í•´ì„¤ -->
      <div class="p-2 bg-green_custom">
        <h2 class="text-lg font-bold text-white text-center">ì‚¬ì£¼í•´ì„¤</h2>
      </div>

      <div class="border-b border-gray-300">
        <div class="mx-auto max-w-sm py-3 px-3 text-center text-gray-500 text-sm flex items-center justify-center gap-2">
          <span>ê° ì œëª©ì„ í´ë¦­í•˜ë©´ í•´ì„¤ì´ í¼ì³ì ¸ìš”</span>
        </div>
      </div>

      <div id="readingAccordion" class="w-full border-b border-black"></div>
    </div>
  </div>

<script>
  // ----- state -----
  let calendar = 'solar'; // solar | lunar
  let isLeapMonth = false;
  let sex = 'M'; // M | F
  let yinYangStyle = 'yang'; // yin | yang (style only)
  const LOADS = [
    "ì£¼ëª¨ê°€ í–¥ë¶ˆì„ í”¼ìš°ê³  ìˆìˆ˜ë‹¤...",
    "íŒ”ìë¥¼ ë“¤ì—¬ë‹¤ë³´ëŠ” ì¤‘ì´ìˆ˜...",
    "ë§‰ê±¸ë¦¬ í•œ ì” ë”°ë¥´ë©° ì ì„ ì¹˜ëŠ” ì¤‘...",
    "ì²œê°„ ì§€ì§€ë¥¼ ì‚´í´ë³´ê³  ìˆìˆ˜ë‹¤...",
    "ì£¼ëª¨ê°€ ëˆˆì„ ê°ê³  ì§‘ì¤‘ ì¤‘ì´ìˆ˜..."
  ];

  // ----- ui helpers -----
  function setBtnActive(btn, active){
    if(active){
      btn.classList.add('bg-black','text-white');
      btn.classList.remove('bg-white','text-black');
    }else{
      btn.classList.remove('bg-black','text-white');
      btn.classList.add('bg-white','text-black');
    }
  }
  function tag(text){
    const s = document.createElement('span');
    s.className = "inline-flex items-center rounded-full border border-yellow-500 bg-yellow-400/50 px-3 py-1 text-gray-800";
    s.textContent = text;
    return s;
  }
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  // ----- bind buttons -----
  const solarBtn = document.getElementById('solarBtn');
  const lunarBtn = document.getElementById('lunarBtn');
  const leapBtn = document.getElementById('leapBtn');
  solarBtn.addEventListener('click', (e)=>{ e.preventDefault(); calendar='solar'; isLeapMonth=false; setBtnActive(solarBtn,true); setBtnActive(lunarBtn,false); leapBtn.classList.remove('bg-black','text-white'); leapBtn.classList.add('bg-white'); });
  lunarBtn.addEventListener('click', (e)=>{ e.preventDefault(); calendar='lunar'; setBtnActive(lunarBtn,true); setBtnActive(solarBtn,false); });
  leapBtn.addEventListener('click', (e)=>{ e.preventDefault(); isLeapMonth=!isLeapMonth; if(isLeapMonth){ leapBtn.classList.add('bg-black','text-white'); leapBtn.classList.remove('bg-white'); } else { leapBtn.classList.remove('bg-black','text-white'); leapBtn.classList.add('bg-white'); } });

  const maleBtn = document.getElementById('maleBtn');
  const femaleBtn = document.getElementById('femaleBtn');
  maleBtn.addEventListener('click', (e)=>{ e.preventDefault(); sex='M'; setBtnActive(maleBtn,true); setBtnActive(femaleBtn,false); });
  femaleBtn.addEventListener('click', (e)=>{ e.preventDefault(); sex='F'; setBtnActive(femaleBtn,true); setBtnActive(maleBtn,false); });

  const yinBtn = document.getElementById('yinBtn');
  const yangBtn = document.getElementById('yangBtn');
  yinBtn.addEventListener('click', (e)=>{ e.preventDefault(); yinYangStyle='yin'; setBtnActive(yinBtn,true); setBtnActive(yangBtn,false); });
  yangBtn.addEventListener('click', (e)=>{ e.preventDefault(); yinYangStyle='yang'; setBtnActive(yangBtn,true); setBtnActive(yinBtn,false); });

  const timeMode = document.getElementById('timeMode');
  const timeInput = document.getElementById('timeInput');
  timeMode.addEventListener('change', ()=>{
    if(timeMode.value==='known'){ timeInput.classList.remove('hidden'); }
    else { timeInput.classList.add('hidden'); }
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    document.getElementById('result').classList.add('hidden');
    document.getElementById('formSection').classList.remove('hidden');
    document.getElementById('resetBtn').classList.add('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  });

  // ----- render helpers -----
  function renderManse(pillars, details){
    // columns: hour/day/month/year (like sample)
    const cols = [
      { key:'hour', label:'ì‹œì£¼' },
      { key:'day', label:'ì¼ì£¼' },
      { key:'month', label:'ì›”ì£¼' },
      { key:'year', label:'ì—°ì£¼' }
    ];
    const colorMap = {
      year: { bg:'rgb(255, 203, 97)', fg:'rgb(87, 86, 79)' },
      month:{ bg:'rgb(155, 126, 189)', fg:'rgb(248, 250, 252)' },
      day:  { bg:'rgb(100, 127, 188)', fg:'rgb(246, 245, 242)' },
      hour: { bg:'rgb(243, 244, 246)', fg:'rgb(31, 41, 55)' }
    };

    const wrap = document.createElement('div');

    // top grid (ì²œê°„/ì§€ì§€)
    const grid = document.createElement('div');
    grid.className = "grid grid-cols-4 border-gray-600 border-b";

    cols.forEach(c=>{
      const p = pillars[c.key];
      const card = document.createElement('div');
      card.className = "flex flex-col items-center border-x border-white";

      const head = document.createElement('div');
      head.className = "p-2 text-center font-semibold text-gray-600 text-sm border-b border-white";
      head.textContent = c.label;
      card.appendChild(head);

      const cm = colorMap[c.key];
      const stem = document.createElement('div');
      stem.className = "p-3 text-center w-full flex-grow flex flex-col justify-center transition-colors duration-300";
      stem.style.backgroundColor = cm.bg;
      stem.style.color = cm.fg;
      stem.innerHTML = p ? `
        <div class="text-3xl font-bold">${escapeHtml(p.stemHan)}</div>
        <div class="text-xs">${escapeHtml(p.stemKr)}</div>
        <div class="text-xs">${escapeHtml(p.shishen?.gan || '')}</div>
      ` : `
        <div class="text-3xl font-bold">-</div>
        <div class="text-xs">-</div>
        <div class="text-xs"></div>
      `;
      card.appendChild(stem);

      const branch = document.createElement('div');
      branch.className = "p-3 text-center w-full flex-grow flex flex-col justify-center border-t border-white transition-colors duration-300";
      branch.style.backgroundColor = cm.bg;
      branch.style.color = cm.fg;
      branch.innerHTML = p ? `
        <div class="text-3xl font-bold">${escapeHtml(p.branchHan)}</div>
        <div class="text-xs">${escapeHtml(p.branchKr)}</div>
        <div class="text-xs">${escapeHtml(p.shishen?.zhi || '')}</div>
      ` : `
        <div class="text-3xl font-bold">-</div>
        <div class="text-xs">-</div>
        <div class="text-xs"></div>
      `;
      card.appendChild(branch);

      grid.appendChild(card);
    });
    wrap.appendChild(grid);

    // hidden stems row
    const row1 = document.createElement('div');
    row1.className = "grid grid-cols-4 items-stretch border-b border-gray-600";
    cols.forEach(c=>{
      const cell = document.createElement('div');
      cell.className = "p-2 text-center text-xs text-gray-600 flex items-center justify-center";
      const list = details?.hideGanKr?.[c.key] || [];
      cell.innerHTML = list.length ? `<div>${list.map(x=>`<div>${escapeHtml(x)}</div>`).join('')}</div>` : `<div>-</div>`;
      row1.appendChild(cell);
    });
    wrap.appendChild(row1);

    // ë””ì‹œ row
    const row2 = document.createElement('div');
    row2.className = "grid grid-cols-4 items-stretch border-b border-gray-600";
    cols.forEach(c=>{
      const cell = document.createElement('div');
      cell.className = "p-2 text-center text-xs text-gray-600 flex items-center justify-center";
      const v = details?.dishi?.[c.key] || '-';
      cell.innerHTML = `<div><div>${escapeHtml(v)}</div></div>`;
      row2.appendChild(cell);
    });
    wrap.appendChild(row2);

    // ê³µë§ row
    const row3 = document.createElement('div');
    row3.className = "grid grid-cols-4 items-stretch border-b border-gray-600";
    cols.forEach(c=>{
      const cell = document.createElement('div');
      cell.className = "p-2 text-center text-xs text-gray-600 flex items-center justify-center";
      const v = details?.xunkong?.[c.key] || '-';
      cell.innerHTML = `<div><div>${escapeHtml(v)}</div></div>`;
      row3.appendChild(cell);
    });
    wrap.appendChild(row3);

    return wrap;
  }

  function renderAccordion(sections){
    const root = document.getElementById('readingAccordion');
    root.innerHTML = "";
    sections.forEach((s, idx)=>{
      const item = document.createElement('details');
      item.className = "border-b border-gray-300";
      if(idx===0) item.open = true;

      const summary = document.createElement('summary');
      summary.className = "list-none cursor-pointer group text-lg font-bold text-gray-800 hover:underline text-left p-4 transition-all duration-200 active:scale-[0.98] flex items-center gap-3";
      summary.innerHTML = `
        <span class="w-5 h-5 flex items-center justify-center text-pink-500 flex-shrink-0">${escapeHtml(s.icon || 'âœ¨')}</span>
        <span class="flex-1">${escapeHtml(s.title || '')}</span>
        <span class="text-gray-500 transition-transform duration-300 group-open:rotate-180">â–¾</span>
      `;
      item.appendChild(summary);

      const body = document.createElement('div');
      body.className = "text-base text-gray-700 whitespace-pre-wrap leading-relaxed px-4 pb-4 pt-0 space-y-4";
      body.textContent = s.body || '';
      item.appendChild(body);

      root.appendChild(item);
    });
  }

  async function getSaju(){
    const name = document.getElementById('nameInput').value.trim();
    const birthDate = document.getElementById('dateInput').value;
    const timeKnown = (document.getElementById('timeMode').value === 'known');
    const birthTime = timeKnown ? document.getElementById('timeInput').value : null;

    if(!birthDate){
      alert("ìƒë…„ì›”ì¼ì„ ë¨¼ì € ê³¨ë¼ì£¼ìŠˆ!");
      return;
    }

    // ui: loading
    document.getElementById('formSection').classList.add('hidden');
    const loadEl = document.getElementById('loading');
    loadEl.classList.remove('hidden');
    const loadingText = document.getElementById('loadingText');
    let i = 0;
    loadingText.textContent = LOADS[0];
    const lt = setInterval(()=>{ i=(i+1)%LOADS.length; loadingText.textContent = LOADS[i]; }, 700);

    try{
      const res = await fetch('/api/saju', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          name: name || null,
          calendar,
          isLeapMonth: calendar==='lunar' ? isLeapMonth : false,
          birthDate,
          birthTime,
          sex,
          yinYangStyle
        })
      });

      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || !data.ok){
        const msg = data?.error?.message || ("ì„œë²„ ì‘ë‹µì´ ì´ìƒí•˜ìˆ˜ë‹¤ ("+res.status+")");
        throw new Error(msg);
      }

      clearInterval(lt);
      loadEl.classList.add('hidden');

      // render result
      const r = data.data;
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('resetBtn').classList.remove('hidden');

      const titleName = document.getElementById('titleName');
      titleName.textContent = (name ? name + "ë‹˜ì˜ ì‚¬ì£¼í•´ì„¤" : "ì‚¬ì£¼í•´ì„¤");

      const tagRow1 = document.getElementById('tagRow1');
      const tagRow2 = document.getElementById('tagRow2');
      tagRow1.innerHTML = "";
      tagRow2.innerHTML = "";

      tagRow1.appendChild(tag(r.meta.solarDate));
      tagRow1.appendChild(tag(calendar==='solar' ? 'ì–‘ë ¥' : 'ìŒë ¥'));
      if(calendar==='lunar' && r.meta.isLeapMonth) tagRow1.appendChild(tag('ìœ¤ë‹¬'));
      tagRow1.appendChild(tag(r.meta.timeKnown ? r.meta.timeText : 'ì‹œê°„ ëª¨ë¦„'));

      tagRow2.appendChild(tag(sex==='M' ? 'ë„ë ¹' : 'ì•„ê°€ì”¨'));

      // ë§Œì„¸ë ¥
      const manseWrap = document.getElementById('manseWrap');
      manseWrap.innerHTML = "";
      manseWrap.appendChild(renderManse(r.pillars, r.details));

      // í•´ì„¤
      renderAccordion(r.readingSections || []);

      window.scrollTo({top:0,behavior:'smooth'});
    }catch(err){
      clearInterval(lt);
      loadEl.classList.add('hidden');
      document.getElementById('formSection').classList.remove('hidden');
      alert("ì•„ì´êµ¬~ ì˜¤ë¥˜ê°€ ë‚¬ìˆ˜ë‹¤!\n" + err.message);
    }
  }

  document.getElementById('submitBtn').addEventListener('click', (e)=>{ e.preventDefault(); getSaju(); });
</script>
</body>
</html>
